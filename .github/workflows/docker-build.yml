name: Build and Push Optimized Docker Images

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ä¼˜å…ˆæž„å»ºæžç®€ç‰ˆæœ¬ï¼ˆæœ€é‡è¦çš„ï¼‰
  build-minimal:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository }}
        tags: |
          type=ref,event=branch,suffix=-minimal
          type=ref,event=pr,suffix=-minimal
          type=semver,pattern={{version}},suffix=-minimal
          type=sha,format=short,suffix=-minimal
          latest={{is_default_branch}}

    - name: Build and push minimal Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile.minimal
        platforms: linux/amd64  # å…ˆåªæž„å»ºamd64å‡å°‘æ—¶é—´
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # å¯é€‰ï¼šæž„å»ºå…¶ä»–ç‰ˆæœ¬
  build-others:
    runs-on: ubuntu-latest
    needs: build-minimal
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    timeout-minutes: 45
    strategy:
      matrix:
        variant: [
          { name: "optimized", dockerfile: "Dockerfile.optimized", suffix: "-optimized" },
          { name: "standard", dockerfile: "Dockerfile", suffix: "" }
        ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for ${{ matrix.variant.name }}
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository }}
        tags: |
          type=ref,event=branch,suffix=${{ matrix.variant.suffix }}
          type=sha,format=short,suffix=${{ matrix.variant.suffix }}

    - name: Build and push ${{ matrix.variant.name }} image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.variant.dockerfile }}
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=${{ matrix.variant.name }}
        cache-to: type=gha,mode=max,scope=${{ matrix.variant.name }}

  # é•œåƒå¤§å°åˆ†æžå’Œæ¯”è¾ƒ
  analyze:
    needs: [build-minimal, build-others]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull and analyze images
      run: |
        echo "## ðŸ“Š Dockeré•œåƒä½“ç§¯å¯¹æ¯”åˆ†æž" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Pull æ‰€æœ‰é•œåƒç‰ˆæœ¬
        docker pull ${{ env.REGISTRY }}/${{ github.repository }}:main || true
        docker pull ${{ env.REGISTRY }}/${{ github.repository }}:main-optimized || true
        docker pull ${{ env.REGISTRY }}/${{ github.repository }}:main-minimal || true
        
        # èŽ·å–é•œåƒå¤§å°
        echo "| ç‰ˆæœ¬ | é•œåƒå¤§å° | ä¼˜åŒ–ç¨‹åº¦ | æŽ¨èç”¨é€” |" >> $GITHUB_STEP_SUMMARY
        echo "|------|----------|----------|----------|" >> $GITHUB_STEP_SUMMARY
        
        # æ ‡å‡†ç‰ˆæœ¬
        if docker images ${{ env.REGISTRY }}/${{ github.repository }}:main --format "table {{.Size}}" | tail -1 > /dev/null 2>&1; then
          STANDARD_SIZE=$(docker images ${{ env.REGISTRY }}/${{ github.repository }}:main --format "{{.Size}}" | head -1)
          echo "| æ ‡å‡†ç‰ˆ | $STANDARD_SIZE | åŸºå‡† | å®Œæ•´åŠŸèƒ½ï¼Œå¼€å‘çŽ¯å¢ƒ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ä¼˜åŒ–ç‰ˆæœ¬
        if docker images ${{ env.REGISTRY }}/${{ github.repository }}:main-optimized --format "table {{.Size}}" | tail -1 > /dev/null 2>&1; then
          OPTIMIZED_SIZE=$(docker images ${{ env.REGISTRY }}/${{ github.repository }}:main-optimized --format "{{.Size}}" | head -1)
          echo "| ä¼˜åŒ–ç‰ˆ | $OPTIMIZED_SIZE | ðŸŸ¢ ä¼˜åŒ– | ç”Ÿäº§çŽ¯å¢ƒï¼Œå¹³è¡¡æ€§èƒ½ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æžç®€ç‰ˆæœ¬
        if docker images ${{ env.REGISTRY }}/${{ github.repository }}:main-minimal --format "table {{.Size}}" | tail -1 > /dev/null 2>&1; then
          MINIMAL_SIZE=$(docker images ${{ env.REGISTRY }}/${{ github.repository }}:main-minimal --format "{{.Size}}" | head -1)
          echo "| æžç®€ç‰ˆ | $MINIMAL_SIZE | ðŸŸ¢ðŸŸ¢ æœ€ä¼˜ | èµ„æºå—é™çŽ¯å¢ƒ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ éƒ¨ç½²å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æžç®€ç‰ˆï¼ˆæŽ¨èï¼‰ï¼š**" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}:latest  # è‡ªåŠ¨ä½¿ç”¨minimalç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ä¼˜åŒ–ç‰ˆï¼š**" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}:main-optimized" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  # è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: [build-minimal]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deploy notification
      run: |
        echo "## ðŸš€ éƒ¨ç½²å°±ç»ª!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### å¯ç”¨é•œåƒç‰ˆæœ¬:" >> $GITHUB_STEP_SUMMARY
        echo "- **æžç®€ç‰ˆ(æŽ¨è):** \`${{ env.REGISTRY }}/${{ github.repository }}:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ä¼˜åŒ–ç‰ˆ:** \`${{ env.REGISTRY }}/${{ github.repository }}:main-optimized\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æ ‡å‡†ç‰ˆ:** \`${{ env.REGISTRY }}/${{ github.repository }}:main\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Docker Compose éƒ¨ç½²:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "docker-compose pull && docker-compose up -d" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
